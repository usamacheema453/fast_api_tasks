<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>
  <body>
    <h2>FastAPI Socket.IO Chat Test</h2>

    <div>
      <h3>1 Register or Login</h3>
      <input id="email" placeholder="email" />
      <input id="name" placeholder="full name" />
      <input id="pass" placeholder="password" type="password" />
      <button onclick="register()">Register</button>
      <button onclick="login()">Login</button>
      <p>Token: <span id="token"></span></p>
    </div>

    <div>
      <h3>2 Create Room</h3>
      <input id="roomTitle" placeholder="room title" />
      <button onclick="createRoom()">Create Room</button>
      <p>Room id: <span id="roomId"></span></p>
    </div>

    <div>
      <h3>3 Connect and Join Room</h3>
      <button onclick="connectSocket()">Connect Socket</button>
      <button onclick="joinRoom()">Join Room</button>
      <p>Status: <span id="status"></span></p>
      <p>Typing: <span id="typing"></span></p>
    </div>

    <div>
      <h3>4 Chat</h3>
      <input id="msg" placeholder="message" oninput="sendTyping(true)" />
      <button onclick="sendMsg()">Send</button>
      <button onclick="sendTyping(false)">Stop Typing</button>
      <pre id="log"></pre>
    </div>

    <script>
      const API = "http://localhost:8000";
      let token = "";
      let roomId = "";
      let socket = null;

      function log(text) {
        const el = document.getElementById("log");
        el.textContent += text + "\n";
      }

      async function register() {
        const email = document.getElementById("email").value;
        const full_name = document.getElementById("name").value;
        const password = document.getElementById("pass").value;

        const res = await fetch(API + "/api/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, full_name, password })
        });

        const data = await res.json();
        token = data.token || "";
        document.getElementById("token").textContent = token;
        log("register response: " + JSON.stringify(data));
      }

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("pass").value;

        const res = await fetch(API + "/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        token = data.token || "";
        document.getElementById("token").textContent = token;
        log("login response: " + JSON.stringify(data));
      }

      async function createRoom() {
        const title = document.getElementById("roomTitle").value;

        const res = await fetch(API + "/api/rooms/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ title })
        });

        const data = await res.json();
        roomId = data.room?.id ? String(data.room.id) : "";
        document.getElementById("roomId").textContent = roomId;
        log("create room response: " + JSON.stringify(data));
      }

      function connectSocket() {
        socket = io(API, {
          auth: { token }
        });

        socket.on("connect", () => {
          document.getElementById("status").textContent = "connected " + socket.id;
          log("socket connected " + socket.id);
        });

        socket.on("disconnect", () => {
          document.getElementById("status").textContent = "disconnected";
          log("socket disconnected");
        });

        socket.on("error", (e) => {
          log("error event: " + JSON.stringify(e));
        });

        socket.on("joined", (e) => {
          log("joined: " + JSON.stringify(e));
        });

        socket.on("typing", (e) => {
          document.getElementById("typing").textContent = JSON.stringify(e);
        });

        socket.on("new_message", (m) => {
          log("new_message: " + JSON.stringify(m));
        });
      }

      function joinRoom() {
        socket.emit("join_room", { room_id: Number(roomId) });
      }

      function sendTyping(is_typing) {
        if (!socket || !roomId) return;
        socket.emit("typing", { room_id: Number(roomId), is_typing });
      }

      function sendMsg() {
        const content = document.getElementById("msg").value;
        socket.emit("send_message", { room_id: Number(roomId), content });
        document.getElementById("msg").value = "";
      }
    </script>
  </body>
</html>
